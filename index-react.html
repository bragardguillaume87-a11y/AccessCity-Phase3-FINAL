<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccessCity - Player & Editor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        primary: '#0e639c',
                        'primary-hover': '#1177bb',
                        'primary-active': '#094771',
                        secondary: '#764ba2'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Poppins', 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #0e639c 0%, #094771 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .btn-primary { 
            background: linear-gradient(135deg, #0e639c 0%, #1177bb 100%); 
            transition: all 0.3s; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(14, 99, 156, 0.4); 
        }
        .tab-active { 
            border-bottom: 3px solid #0e639c; 
            color: #0e639c; 
            font-weight: 600; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        .stage-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }
        
        .character-portrait {
            position: absolute;
            bottom: 0;
            max-height: 60%;
            z-index: 10;
            transition: all 0.5s ease;
        }
        
        .dialogue-box {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            background: linear-gradient(135deg, rgba(37, 37, 38, 0.98) 0%, rgba(30, 30, 30, 0.95) 100%);
            border: 2px solid #0e639c;
            border-radius: 12px;
            padding: 24px;
            color: #e0e0e0;
            z-index: 20;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 20px rgba(14, 99, 156, 0.25);
        }
        
        .choice-btn {
            background: #2d2d30;
            color: #e0e0e0;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            transition: all 0.2s;
            cursor: pointer;
            text-align: left;
        }
        .choice-btn:hover {
            background: #0e639c;
            border-color: #1177bb;
            transform: translateX(4px);
        }
        /* Overlay d‚Äôaide (coach marks) */
        .overlay-dim { background: rgba(0,0,0,0.6); }
        .coach-bubble { background: #fef08a; color: #0b1220; border: 2px solid #facc15; }
        /* Badges de deltas variables */
        @keyframes riseFade {
            0% { opacity: 0; transform: translateY(8px) scale(0.98); }
            15% { opacity: 1; transform: translateY(0) scale(1); }
            85% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-8px) scale(0.98); }
        }
        .delta-badge { 
            animation: riseFade 1.5s ease forwards; 
            box-shadow: 0 6px 14px rgba(0,0,0,0.25);
        }
            .layer-10 { z-index: 10; }
            .layer-20 { z-index: 20; }
            .layer-30 { z-index: 30; }
            .layer-40 { z-index: 40; }
            .layer-50 { z-index: 50; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        // Utilitaire: pi√®ge √† focus pour modales (Tab/Shift+Tab cyclique)
        function trapFocus(container) {
            if (!container) return () => {};
            const selectors = [
                'a[href]', 'button', 'input', 'select', 'textarea', '[tabindex]:not([tabindex="-1"])'
            ];
            const getFocusables = () => Array.from(container.querySelectorAll(selectors.join(',')))
                .filter(el => !el.hasAttribute('disabled') && el.offsetParent !== null);
            const handler = (e) => {
                if (e.key !== 'Tab') return;
                const focusables = getFocusables();
                if (focusables.length === 0) return;
                const first = focusables[0];
                const last = focusables[focusables.length - 1];
                if (e.shiftKey) {
                    if (document.activeElement === first || !container.contains(document.activeElement)) {
                        e.preventDefault();
                        last.focus();
                    }
                } else {
                    if (document.activeElement === last) {
                        e.preventDefault();
                        first.focus();
                    }
                }
            };
            container.addEventListener('keydown', handler);
            return () => container.removeEventListener('keydown', handler);
        }
        
        // ==================== CORE MODULES (Vanilla JS int√©gr√©s) ====================
        
        class EventBus {
            constructor() {
                this.events = {};
            }
            on(event, callback) {
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(callback);
            }
            emit(event, data) {
                if (this.events[event]) {
                    this.events[event].forEach(cb => cb(data));
                }
            }
            off(event, callback) {
                if (!this.events[event]) return;
                this.events[event] = this.events[event].filter(cb => cb !== callback);
            }
        }
        
        class VariableManager {
            constructor() {
                this.variables = {
                    'Physique': 100,
                    'Mentale': 100
                };
            }
            get(name) {
                return this.variables[name] !== undefined ? this.variables[name] : 0;
            }
            set(name, value) {
                this.variables[name] = value;
            }
            modify(name, delta) {
                const current = this.get(name);
                this.set(name, Math.max(0, Math.min(100, current + delta)));
            }
            getAll() {
                return { ...this.variables };
            }
        }
        
        class ConditionEvaluator {
            constructor(variableManager) {
                this.variableManager = variableManager;
            }
            evaluate(conditions) {
                if (!conditions || conditions.length === 0) return true;
                return conditions.every(cond => {
                    const varValue = this.variableManager.get(cond.variable);
                    switch (cond.operator) {
                        case '>=': return varValue >= cond.value;
                        case '<=': return varValue <= cond.value;
                        case '>': return varValue > cond.value;
                        case '<': return varValue < cond.value;
                        case '==': return varValue == cond.value;
                        case '!=': return varValue != cond.value;
                        default: return false;
                    }
                });
            }
        }
        
        class DialogueEngine {
            constructor(eventBus, variableManager) {
                this.eventBus = eventBus;
                this.variableManager = variableManager;
                this.conditionEvaluator = new ConditionEvaluator(variableManager);
                this.currentScene = null;
                this.currentDialogueIndex = 0;
            }
            
            loadScene(scene) {
                this.currentScene = scene;
                this.currentDialogueIndex = 0;
                this.showCurrentDialogue();
            }
            
            showCurrentDialogue() {
                if (!this.currentScene) return;
                
                while (this.currentDialogueIndex < this.currentScene.dialogues.length) {
                    const dialogue = this.currentScene.dialogues[this.currentDialogueIndex];
                    
                    if (this.conditionEvaluator.evaluate(dialogue.conditions)) {
                        this.eventBus.emit('dialogue:show', {
                            speaker: dialogue.speaker,
                            text: dialogue.text,
                            choices: dialogue.choices || []
                        });
                        return;
                    }
                    
                    this.currentDialogueIndex++;
                }
                
                this.eventBus.emit('scene:complete', { sceneId: this.currentScene.id });
            }
            
            handleChoice(choice) {
                if (choice.effects) {
                    const deltas = [];
                    choice.effects.forEach(effect => {
                        const before = this.variableManager.get(effect.variable);
                        if (effect.operation === 'set') {
                            this.variableManager.set(effect.variable, effect.value);
                            deltas.push({ variable: effect.variable, delta: effect.value - before });
                        } else if (effect.operation === 'add') {
                            this.variableManager.modify(effect.variable, effect.value);
                            deltas.push({ variable: effect.variable, delta: effect.value });
                        }
                    });
                    this.eventBus.emit('variables:delta', deltas);
                    this.eventBus.emit('variables:updated', this.variableManager.getAll());
                }
                this.next();
            }
            
            next() {
                this.currentDialogueIndex++;
                this.showCurrentDialogue();
            }
        }
        
        // ==================== DATA SAMPLE ====================
        
        const SAMPLE_DATA = {
            characters: [
                {
                    id: "player",
                    name: "Joueur",
                    sprites: { neutral: "assets/characters/player/neutral.svg" },
                    moods: ["neutral"]
                },
                {
                    id: "counsellor",
                    name: "Conseiller municipal",
                    sprites: { neutral: "assets/characters/counsellor/neutral.svg" },
                    moods: ["neutral", "professional", "helpful"]
                },
                {
                    id: "narrator",
                    name: "Narrateur",
                    sprites: {},
                    moods: []
                }
            ],
            scenes: [
                {
                    id: "scene_test_01",
                    title: "Rencontre Mairie",
                    description: "Premiere scene de test avec variables.",
                    dialogues: [
                        {
                            speaker: "narrator",
                            text: "Vous arrivez devant l'imposant batiment de la mairie."
                        },
                        {
                            speaker: "counsellor",
                            text: "Bonjour ! Je suis ravi de vous voir pour discuter du projet d'accessibilite."
                        },
                        {
                            speaker: "player",
                            text: "...",
                            choices: [
                                {
                                    text: "Bonjour, je suis tres motive !",
                                    effects: [{ variable: "Mentale", value: 5, operation: "add" }]
                                },
                                {
                                    text: "Je n'ai pas beaucoup de temps.",
                                    effects: [{ variable: "Mentale", value: -5, operation: "add" }]
                                }
                            ]
                        },
                        {
                            speaker: "counsellor",
                            text: "C'est formidable de sentir votre enthousiasme !",
                            conditions: [{ variable: "Mentale", operator: ">=", value: 95 }]
                        },
                        {
                            speaker: "counsellor",
                            text: "Tres bien, nous allons faire vite alors.",
                            conditions: [{ variable: "Mentale", operator: "<", value: 95 }]
                        },
                        {
                            speaker: "narrator",
                            text: "Apres l'entretien, vous retournez a votre vehicule."
                        }
                    ]
                },
                {
                    id: "scene_test_02",
                    title: "Suite de l'aventure",
                    description: "Deuxieme scene.",
                    dialogues: [
                        {
                            speaker: "narrator",
                            text: "Une nouvelle journee commence..."
                        }
                    ]
                }
            ]
        };
        
        // ==================== UI LAYOUTS (fallback minimal si fetch indisponible) ====================
        const FALLBACK_LAYOUTS = {
            version: "fallback",
            layouts: {
                standard: {
                    description: "Disposition editeur complete",
                    panels: [
                        { id: 'scene-list', visible: true, position: 'left', width: 260 },
                        { id: 'inspector', visible: true, position: 'center', flex: 1 },
                        { id: 'devtools', visible: true, position: 'right', width: 320 }
                    ]
                },
                focus: {
                    description: "Mode focus sur l'ecriture",
                    panels: [
                        { id: 'scene-list', visible: false, position: 'left', width: 0 },
                        { id: 'inspector', visible: true, position: 'center', flex: 1 },
                        { id: 'devtools', visible: true, position: 'right', width: 280 }
                    ]
                },
                accessibility: {
                    description: "Mode accessibilite",
                    panels: [
                        { id: 'scene-list', visible: true, position: 'left', width: 300 },
                        { id: 'inspector', visible: true, position: 'center', flex: 1 },
                        { id: 'devtools', visible: false, position: 'right', width: 0 }
                    ]
                },
                devtools: {
                    description: "Mode debug",
                    panels: [
                        { id: 'scene-list', visible: true, position: 'left', width: 220 },
                        { id: 'inspector', visible: true, position: 'center', flex: 1 },
                        { id: 'devtools', visible: true, position: 'right', width: 380 }
                    ]
                }
            }
        };
        
        // ==================== MAIN APP ====================
        
        function App() {
            const [mode, setMode] = useState('editor'); // 'editor' or 'player'
            // Accessibilit√© par d√©faut pour une meilleure lisibilit√©
            const [currentLayout, setCurrentLayout] = useState('accessibility');
            const [scenes, setScenes] = useState(SAMPLE_DATA.scenes);
            const [characters, setCharacters] = useState(SAMPLE_DATA.characters);
            const [selectedSceneId, setSelectedSceneId] = useState(null);
            const [selectedSceneForEdit, setSelectedSceneForEdit] = useState(null);
            const [variables, setVariables] = useState({ Physique: 100, Mentale: 100 });
            const [backgroundsHistory, setBackgroundsHistory] = useState([]); // derniers d√©cors choisis
            const [editingCharacter, setEditingCharacter] = useState(null);
            // UI layouts charg√©s depuis data/ui_layout.json
            const [uiLayouts, setUiLayouts] = useState(null);
            // Onboarding + objectif courant
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [objective, setObjective] = useState("Parler au conseiller √† la mairie");
            const [showHint, setShowHint] = useState(false);
            // Studio workflow steps (th√©√¢tre): Contexte ‚Üí Personnages ‚Üí Sc√®nes ‚Üí Dialogues ‚Üí Pr√©visualisation ‚Üí Export
            const studioSteps = ['Contexte', 'Personnages', 'Sc√®nes', 'Dialogues', 'Pr√©visualisation', 'Export'];
            // Contexte form state
            const [contextTitle, setContextTitle] = useState('');
            const [contextErrors, setContextErrors] = useState({ title: '' });
            // Toast notifications
            const [toast, setToast] = useState(null);
            
            const showToast = (message, type = 'info') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 2500);
            };
            const [stepStatus, setStepStatus] = useState(() => {
                // initial: √©tape 0 en cours, les autres non d√©marr√©es
                return [1, 0, 0, 0, 0, 0];
            });
            const badgeFor = (status) => status === 2 ? '‚úì' : status === 1 ? '‚óè' : '‚óã';
            const gotoStep = (idx) => {
                setCurrentStep(idx);
                setStepStatus(prev => {
                    const next = [...prev];
                    next[idx] = next[idx] === 2 ? 2 : 1;
                    return next;
                });
            };
            const [currentStep, setCurrentStep] = useState(0); // D√©marre sur Contexte
            const [showSidePreview, setShowSidePreview] = useState(() => {
                const saved = window.localStorage.getItem('ac_showSidePreview');
                return saved === 'true';
            });
                        // Navigation helpers
                        const prevStep = () => {
                            setCurrentStep((idx) => {
                                const nextIdx = Math.max(0, idx - 1);
                                setStepStatus((prev) => {
                                    const next = [...prev];
                                    next[idx] = next[idx] === 2 ? 2 : 1; // conserve l'√©tat de l'√©tape quittee
                                    next[nextIdx] = 1; // √©tape cible en cours
                                    return next;
                                });
                                return nextIdx;
                            });
                        };
                        const nextStep = () => {
                            setCurrentStep((idx) => {
                                // Validation gating for Contexte (step 0)
                                if (idx === 0) {
                                    const errs = { title: '' };
                                    if (!contextTitle || contextTitle.trim().length === 0) {
                                        errs.title = 'Le titre est requis.';
                                    }
                                    setContextErrors(errs);
                                    if (errs.title) {
                                        showToast('Veuillez renseigner le titre du sc√©nario.', 'warn');
                                        return idx; // block advance
                                    }
                                }
                                const nextIdx = Math.min(studioSteps.length - 1, idx + 1);
                                setStepStatus((prev) => {
                                    const next = [...prev];
                                    next[idx] = 2; // √©tape actuelle termin√©e
                                    next[nextIdx] = next[nextIdx] === 2 ? 2 : 1; // prochaine en cours
                                    return next;
                                });
                                return nextIdx;
                            });
                        };
            
            const eventBusRef = useRef(new EventBus());
            const variableManagerRef = useRef(new VariableManager());
            const dialogueEngineRef = useRef(null);
            
            useEffect(() => {
                dialogueEngineRef.current = new DialogueEngine(
                    eventBusRef.current,
                    variableManagerRef.current
                );
                
                eventBusRef.current.on('variables:updated', (vars) => {
                    setVariables(vars);
                });
                // Auto-s√©lectionner le premier chapitre et afficher onboarding au premier d√©marrage
                if (SAMPLE_DATA.scenes && SAMPLE_DATA.scenes.length > 0) {
                    setSelectedSceneId(SAMPLE_DATA.scenes[0].id);
                }
                const onboarded = window.localStorage.getItem('ac_onboarded');
                if (!onboarded) {
                    setShowOnboarding(true);
                }
                // Charger layouts JSON avec fallback
                (async () => {
                    try {
                        const res = await fetch('data/ui_layout.json');
                        if (!res.ok) throw new Error('fetch failed');
                        const json = await res.json();
                        setUiLayouts(json);
                    } catch (e) {
                        setUiLayouts(FALLBACK_LAYOUTS);
                    }
                })();
            }, []);
            
            const playScene = (sceneId) => {
                const scene = scenes.find(s => s.id === sceneId);
                if (!scene) return;
                setSelectedSceneId(sceneId);
                setMode('player');
            };
            
            const saveCharacter = (updatedCharacter) => {
                setCharacters(chars => chars.map(c => c.id === updatedCharacter.id ? updatedCharacter : c));
                setEditingCharacter(null);
                eventBusRef.current.emit('character:updated', updatedCharacter);
            };
            
            const addNewCharacter = () => {
                const newChar = {
                    id: `custom_${Date.now()}`,
                    name: 'Nouveau personnage',
                    description: 'Un nouveau personnage',
                    sprites: { neutral: '', happy: '', sad: '', professional: '' },
                    moods: ['neutral']
                };
                setCharacters([...characters, newChar]);
                setEditingCharacter(newChar);
            };

            // Scenes CRUD helpers
            const addScene = () => {
                const newId = `scene_${Date.now()}`;
                const newScene = { id: newId, title: 'Nouvelle sc√®ne', description: '', backgroundUrl: '', dialogues: [] };
                setScenes(prev => [...prev, newScene]);
                setSelectedSceneForEdit(newId);
                showToast('Sc√®ne ajout√©e', 'success');
            };
            const removeScene = (sceneId) => {
                if (!window.confirm('√ätes-vous s√ªr de vouloir supprimer cette sc√®ne ?')) return;
                setScenes(prev => prev.filter(s => s.id !== sceneId));
                if (selectedSceneForEdit === sceneId) setSelectedSceneForEdit(null);
                if (selectedSceneId === sceneId) setSelectedSceneId(null);
                showToast('Sc√®ne supprim√©e', 'warn');
            };
            const updateScene = (sceneId, patch) => {
                setScenes(prev => prev.map(s => s.id === sceneId ? { ...s, ...patch } : s));
                if (patch && typeof patch.backgroundUrl === 'string') {
                    const url = patch.backgroundUrl.trim();
                    if (url) {
                        setBackgroundsHistory(prev => {
                            const next = [url, ...prev.filter(u => u !== url)];
                            return next.slice(0, 6);
                        });
                    }
                }
            };

            // Export helpers
            const exportJson = (filename, data) => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                showToast(`Fichier ${filename} t√©l√©charg√©`, 'success');
            };
            const exportScenes = () => exportJson('scenes.json', scenes);
            const exportCharacters = () => exportJson('characters.json', characters);
            const exportCore = () => exportJson('core_system.json', { title: contextTitle || 'Sans titre' });
            
            return (
                <div className="min-h-screen">
                    <header className="gradient-bg text-white py-6 shadow-lg">
                        <div className="container mx-auto px-4 text-center">
                            <h1 className="text-4xl font-bold tracking-tight">üéÆ AccessCity</h1>
                            <p className="text-sm opacity-90 mt-1">G√©n√©rateur de sc√©narios ‚Äî Jouer & √âditer</p>
                        </div>
                    </header>
                    
                    <div className="bg-white shadow-md border-b-2 border-gray-200">
                        <div className="container mx-auto px-4">
                            {mode === 'editor' ? (
                                <div className="flex justify-between items-center">
                                    <div className="flex gap-2 overflow-x-auto">
                                        {studioSteps.map((step, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => gotoStep(idx)}
                                                className={'px-5 py-4 whitespace-nowrap transition-all flex items-center gap-2 ' + (currentStep === idx ? 'tab-active' : 'text-gray-600 hover:bg-gray-50')}
                                            >
                                                <span className={stepStatus[idx] === 2 ? 'text-green-600' : stepStatus[idx] === 1 ? 'text-blue-600' : 'text-gray-500'}>{badgeFor(stepStatus[idx])}</span>
                                                <span>{idx + 1}. {step}</span>
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex gap-2 items-center">
                                        <button
                                            onClick={() => setShowSidePreview(v => {
                                                const next = !v;
                                                window.localStorage.setItem('ac_showSidePreview', next.toString());
                                                return next;
                                            })}
                                            className="px-3 py-2 text-sm rounded bg-primary text-white hover:bg-primary-hover whitespace-nowrap"
                                        >
                                            {showSidePreview ? 'üìê Masquer pr√©view' : 'üëÅÔ∏è Afficher pr√©view'}
                                        </button>
                                        <select
                                            value={currentLayout}
                                            onChange={(e) => setCurrentLayout(e.target.value)}
                                            className="px-3 py-2 text-sm rounded bg-gray-100 hover:bg-gray-200"
                                            title="Vue de l'√©diteur"
                                        >
                                            <option value="standard">Standard</option>
                                            <option value="focus">Focus</option>
                                            <option value="accessibility">Accessibilit√©</option>
                                            <option value="devtools">Debug</option>
                                        </select>
                                        <span title="Infos: Navigue entre les √©tapes pour cr√©er ton sc√©nario" className="ml-1 text-yellow-500 cursor-help">üí°</span>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex justify-between items-center">
                                    <button
                                        onClick={() => setMode('editor')}
                                        className="px-6 py-4 text-gray-600 hover:bg-gray-50 transition-all"
                                    >
                                        ‚Üê Retour √† l'√©diteur
                                    </button>
                                    <p className="text-sm text-gray-600">Mode Joueur</p>
                                </div>
                            )}
                            {/* HUD Objectif + aide */}
                            <div className="flex items-center justify-between py-3 text-gray-700">
                                <div className="flex items-center gap-2">
                                    <span className="text-base font-semibold text-primary">üéØ Objectif:</span>
                                    <span className="text-base font-medium">{objective}</span>
                                </div>
                                <button
                                    onClick={() => setShowHint(v => !v)}
                                    className="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm"
                                >
                                    O√π aller ?
                                </button>
                            </div>
                            {showHint && (
                                <div className="mb-3 p-3 bg-blue-50 border-l-4 border-primary rounded text-sm text-gray-700">
                                    Astuce: ouvre l‚Äôonglet ‚Äúüìã Chapitres‚Äù et clique sur le bouton ‚ñ∂ du premier chapitre pour commencer. Bonne chance !
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div className="container mx-auto px-4 py-8">
                        {mode === 'editor' && (
                            <div className={showSidePreview ? 'grid grid-cols-1 lg:grid-cols-2 gap-6' : ''}>
                                <div className="fade-in">
                                    {currentStep === 0 && (
                                        <div className="bg-white rounded-xl shadow-md p-8">
                                            <h2 className="text-2xl font-bold mb-2">√âtape 1 : Contexte</h2>
                                            <p className="text-gray-600 mb-6">üé¨ D√©finis le cadre de ton sc√©nario</p>
                                            <div className="mb-4">
                                                <label className="block text-sm font-semibold mb-2">Titre du sc√©nario</label>
                                                <input 
                                                    type="text" 
                                                    value={contextTitle}
                                                    onChange={(e)=>{ setContextTitle(e.target.value); if (contextErrors.title) setContextErrors({ ...contextErrors, title: '' }); }}
                                                    placeholder="Ex: Aventure √† la mairie" 
                                                    className={`w-full px-4 py-3 border-2 rounded-lg focus:border-primary focus:outline-none ${contextErrors.title ? 'border-red-400' : 'border-gray-200'}`}
                                                />
                                                {contextErrors.title && (
                                                    <p className="text-red-600 text-xs mt-1">{contextErrors.title}</p>
                                                )}
                                            </div>
                                            <div className="grid md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-sm font-semibold mb-2">Lieu principal</label>
                                                    <input type="text" placeholder="Ex: Mairie" className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary focus:outline-none" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold mb-2">Ton</label>
                                                    <select className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary focus:outline-none">
                                                        <option value="realiste">R√©aliste</option>
                                                        <option value="humoristique">Humoristique</option>
                                                        <option value="poetique">Po√©tique</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div className="mb-6">
                                                <label className="block text-sm font-semibold mb-2">Description</label>
                                                <textarea rows="4" placeholder="D√©cris la situation..." className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-primary focus:outline-none resize-none" />
                                            </div>
                                            <p className="text-xs text-gray-500 mb-4">Note: Ces donn√©es seront sauvegard√©es dans data/core_system.json lors de l'export.</p>
                                            <div className="flex justify-between mt-6">
                                                <div />
                                                <button onClick={nextStep} className="btn-primary text-white px-6 py-3 rounded-lg font-semibold focus:ring-2 focus:ring-primary">Suivant ‚Üí</button>
                                            </div>
                                        </div>
                                    )}
                                    {currentStep === 1 && (
                                        <>
                                            <EditorMode 
                                                scenes={scenes} 
                                                characters={characters}
                                                variables={variables}
                                                onPlayScene={playScene}
                                                onEditCharacter={setEditingCharacter}
                                                onAddCharacter={addNewCharacter}
                                                currentLayout={currentLayout}
                                                layout={uiLayouts ? uiLayouts.layouts[currentLayout] : null}
                                            />
                                            {editingCharacter && (
                                                <CharacterEditor 
                                                    character={editingCharacter}
                                                    onSave={saveCharacter}
                                                    onClose={() => setEditingCharacter(null)}
                                                />
                                            )}
                                        </>
                                    )}
                                    {currentStep === 2 && (
                                        <div className="bg-white rounded-xl shadow-md p-8">
                                            <h2 className="text-2xl font-bold mb-2">√âtape 3 : Sc√®nes</h2>
                                            <p className="text-gray-600 mb-6">üèüÔ∏è Configure les lieux et chapitres (d√©cors), lance avec ‚ñ∂</p>
                                            <div className="grid md:grid-cols-2 gap-6">
                                                <div>
                                                    <h3 className="text-lg font-semibold mb-3 text-primary">üìã Liste des sc√®nes</h3>
                                                    <div className="space-y-2">
                                                        {scenes.map(scene => (
                                                            <div key={scene.id} className="border-2 border-gray-200 rounded-lg p-3 hover:border-primary transition-all layer-20 overflow-hidden">
                                                                <div className="flex justify-between items-start layer-30 flex-wrap">
                                                                    <div className="flex-1">
                                                                        <div className="flex items-center gap-2 flex-wrap">
                                                                            <input 
                                                                                className="font-semibold flex-1 border-b border-gray-200 focus:border-primary outline-none bg-transparent"
                                                                                value={scene.title}
                                                                                onChange={(e)=>updateScene(scene.id, { title: e.target.value })}
                                                                            />
                                                                            <button
                                                                                onClick={()=>setSelectedSceneForEdit(scene.id)}
                                                                                className={`text-xs px-2 py-1 rounded ${selectedSceneForEdit===scene.id?'bg-primary text-white':'bg-gray-100 text-gray-700'}`}
                                                                            >Configurer</button>
                                                                            <button
                                                                                onClick={()=>removeScene(scene.id)}
                                                                                className="text-xs px-2 py-1 rounded bg-red-500 text-white"
                                                                            >Supprimer</button>
                                                                        </div>
                                                                        <p className="text-xs text-gray-500">{scene.dialogues.length} dialogues</p>
                                                                    </div>
                                                                    <button 
                                                                        onClick={() => playScene(scene.id)}
                                                                        className="bg-primary text-white px-3 py-1 rounded-lg hover:bg-primary-hover transition-all text-sm focus:ring-2 focus:ring-primary"
                                                                        aria-label="Lancer la sc√®ne"
                                                                    >‚ñ∂</button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                    <div className="mt-3">
                                                        <button onClick={addScene} className="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm">+ Ajouter une sc√®ne</button>
                                                    </div>
                                                </div>
                                                <div>
                                                    <h3 className="text-lg font-semibold mb-3 text-primary">üé≠ D√©cor / Lieu</h3>
                                                    {selectedSceneForEdit ? (
                                                        <div className="space-y-3">
                                                            <div className="border-2 border-gray-200 rounded-lg p-4">
                                                                <label className="block text-sm font-semibold mb-2">URL du d√©cor (image)</label>
                                                                <input 
                                                                    type="text"
                                                                    className="w-full px-3 py-2 border-2 border-gray-200 rounded focus:border-primary outline-none"
                                                                    placeholder="assets/backgrounds/city.jpg ou URL"
                                                                    value={scenes.find(s=>s.id===selectedSceneForEdit)?.backgroundUrl || ''}
                                                                    onChange={(e)=>updateScene(selectedSceneForEdit, { backgroundUrl: e.target.value })}
                                                                />
                                                            </div>
                                                            {/* Galerie d'assets depuis assets/backgrounds */}
                                                            <div className="border-2 border-gray-200 rounded-lg p-4">
                                                                <p className="text-sm font-semibold mb-2">Galerie de d√©cors</p>
                                                                <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                                                    {['assets/backgrounds/city_street.svg'].map((bg) => (
                                                                        <button key={bg} onClick={()=>updateScene(selectedSceneForEdit, { backgroundUrl: bg })} className="rounded overflow-hidden border hover:border-primary">
                                                                            <img src={bg} alt="bg" className="w-full h-24 object-cover" />
                                                                            <div className="text-[11px] px-2 py-1 text-left text-gray-600">{bg.split('/').slice(-1)[0]}</div>
                                                                        </button>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                            {backgroundsHistory.length > 0 && (
                                                                <div className="border-2 border-gray-200 rounded-lg p-4">
                                                                    <p className="text-sm font-semibold mb-2">D√©cors r√©cents</p>
                                                                    <div className="flex flex-wrap gap-2">
                                                                        {backgroundsHistory.map((bg)=> (
                                                                            <button key={bg} onClick={()=>updateScene(selectedSceneForEdit, { backgroundUrl: bg })} className="text-xs px-2 py-1 rounded bg-gray-100 hover:bg-gray-200">
                                                                                {bg}
                                                                            </button>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                            )}
                                                            <div className="border-2 border-gray-200 rounded-lg p-4">
                                                                <p className="text-sm text-gray-600 mb-2">Aper√ßu du d√©cor</p>
                                                                {scenes.find(s=>s.id===selectedSceneForEdit)?.backgroundUrl ? (
                                                                    <img src={scenes.find(s=>s.id===selectedSceneForEdit)?.backgroundUrl} alt="D√©cor" className="w-full max-h-64 object-cover rounded" />
                                                                ) : (
                                                                    <div className="w-full h-32 bg-gray-100 rounded flex items-center justify-center text-gray-400 text-sm">Aucune image</div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="border-2 border-gray-200 rounded-lg p-4 text-sm text-gray-600">
                                                            S√©lectionne une sc√®ne dans la liste pour configurer son d√©cor.
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                            <div className="flex gap-3 mt-6">
                                                <button onClick={prevStep} className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold focus:ring-2 focus:ring-gray-400">‚Üê Pr√©c√©dent</button>
                                                <button onClick={nextStep} className="btn-primary text-white px-6 py-3 rounded-lg font-semibold focus:ring-2 focus:ring-primary">Suivant ‚Üí</button>
                                            </div>
                                        </div>
                                    )}
                                    {currentStep === 3 && (
                                        <div className="bg-white rounded-xl shadow-md p-8">
                                            <h2 className="text-2xl font-bold mb-2">√âtape 4 : Dialogues</h2>
                                            <p className="text-gray-600 mb-6">üí¨ Compose tes dialogues et choix</p>
                                            <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                                                <p className="text-blue-800">üí° Pour l'instant, utilise l'√©tape <strong>Sc√®nes</strong> ou le panneau <strong>Personnages</strong> pour ajouter des dialogues via l'interface actuelle.</p>
                                                <p className="text-sm text-blue-700 mt-2">Un √©diteur de dialogues visuel sera ajout√© prochainement (structure compatible data/scenes.json).</p>
                                            </div>
                                            <div className="flex gap-3">
                                                <button onClick={prevStep} className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold focus:ring-2 focus:ring-gray-400">‚Üê Pr√©c√©dent</button>
                                                <button onClick={nextStep} className="btn-primary text-white px-6 py-3 rounded-lg font-semibold focus:ring-2 focus:ring-primary">Suivant ‚Üí</button>
                                            </div>
                                        </div>
                                    )}
                                    {currentStep === 4 && (
                                        <div className="bg-white rounded-xl shadow-md p-8">
                                            <h2 className="text-2xl font-bold mb-2">√âtape 5 : Pr√©visualisation</h2>
                                            <p className="text-gray-600 mb-6">üéÆ Teste ton sc√©nario en temps r√©el</p>
                                            <div className="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-4">
                                                <p className="text-green-800">‚úÖ Clique sur <strong>"Afficher pr√©view"</strong> en haut √† droite pour ouvrir la pr√©visualisation agrandie.</p>
                                                <p className="text-sm text-green-700 mt-2">Ou utilise le bouton ‚ñ∂ d'un chapitre pour passer en mode Joueur plein √©cran.</p>
                                            </div>
                                            <div className="flex gap-3">
                                                <button onClick={prevStep} className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold focus:ring-2 focus:ring-gray-400">‚Üê Pr√©c√©dent</button>
                                                <button onClick={nextStep} className="btn-primary text-white px-6 py-3 rounded-lg font-semibold focus:ring-2 focus:ring-primary">Suivant ‚Üí</button>
                                            </div>
                                        </div>
                                    )}
                                    {currentStep === 5 && (
                                        <div className="bg-white rounded-xl shadow-md p-8">
                                            <h2 className="text-2xl font-bold mb-2">√âtape 6 : Export</h2>
                                            <p className="text-gray-600 mb-6">üì• Exporte ton sc√©nario complet</p>
                                            <div className="space-y-3 mb-6">
                                                <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                                                    <p className="font-semibold">Personnages: {characters.length}</p>
                                                </div>
                                                <div className="bg-gray-50 border-2 border-gray-200 rounded-lg p-4">
                                                    <p className="font-semibold">Sc√®nes: {scenes.length}</p>
                                                </div>
                                            </div>
                                            <p className="text-xs text-gray-500 mb-4">T√©l√©charge s√©par√©ment les fichiers JSON compatibles AccessCity (import possibles dans GDevelop).</p>
                                            <div className="flex flex-wrap gap-2">
                                                <button onClick={exportScenes} className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold focus:ring-2 focus:ring-green-400">üì• scenes.json</button>
                                                <button onClick={exportCharacters} className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold focus:ring-2 focus:ring-green-400">üì• characters.json</button>
                                                <button onClick={exportCore} className="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 font-semibold focus:ring-2 focus:ring-green-400">üì• core_system.json</button>
                                            </div>
                                            <div className="mt-4">
                                                <button onClick={prevStep} className="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold focus:ring-2 focus:ring-gray-400">‚Üê Pr√©c√©dent</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                                {showSidePreview && (
                                    <div className="fade-in">
                                        {selectedSceneId ? (
                                            <div className="bg-white rounded-xl shadow-lg p-4">
                                                <h3 className="font-semibold mb-3 text-primary">Pr√©visualisation</h3>
                                                <PlayerMode 
                                                    scene={scenes.find(s => s.id === selectedSceneId)}
                                                    characters={characters}
                                                    variables={variables}
                                                    dialogueEngine={dialogueEngineRef.current}
                                                    eventBus={eventBusRef.current}
                                                    onExit={() => setShowSidePreview(false)}
                                                />
                                            </div>
                                        ) : (
                                            <div className="bg-white rounded-xl shadow-lg p-8 text-center">
                                                <p className="text-gray-500 mb-3">üé¨ Aucune sc√®ne s√©lectionn√©e</p>
                                                <p className="text-sm text-gray-400">Va dans l'√©tape <strong>Personnages</strong> et clique sur ‚ñ∂ d'un chapitre pour pr√©visualiser.</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                        {mode === 'player' && selectedSceneId && (
                            <PlayerMode 
                                scene={scenes.find(s => s.id === selectedSceneId)}
                                characters={characters}
                                variables={variables}
                                dialogueEngine={dialogueEngineRef.current}
                                eventBus={eventBusRef.current}
                                onExit={() => setMode('editor')}
                            />
                        )}
                        {showOnboarding && (
                            <OnboardingModal 
                                onClose={() => { window.localStorage.setItem('ac_onboarded','true'); setShowOnboarding(false); }}
                            />
                        )}
                        {/* Toast notifications */}
                        {toast && (
                            <div 
                                role="status" 
                                aria-live="polite" 
                                className={`fixed bottom-6 right-6 px-6 py-3 rounded-lg shadow-lg text-white font-medium layer-50 ${
                                    toast.type === 'success' ? 'bg-green-600' : 
                                    toast.type === 'warn' ? 'bg-yellow-600' : 
                                    'bg-blue-600'
                                }`}
                            >
                                {toast.message}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ==================== ONBOARDING MODAL ====================
        function OnboardingModal({ onClose }) {
            const [step, setStep] = useState(0);
            const dialogRef = useRef(null);
            useEffect(() => {
                const prevOverflow = document.body.style.overflow;
                document.body.style.overflow = 'hidden';
                const prevActive = document.activeElement;
                if (dialogRef.current) {
                    dialogRef.current.focus();
                }
                const cleanupTrap = trapFocus(dialogRef.current);
                return () => {
                    document.body.style.overflow = prevOverflow;
                    cleanupTrap && cleanupTrap();
                    if (prevActive && typeof prevActive.focus === 'function') {
                        try { prevActive.focus(); } catch {}
                    }
                };
            }, []);
            const steps = [
                {
                    title: "Bienvenue dans AccessCity !",
                    text: "Tu vas aider √† rendre la ville plus accueillante. C‚Äôest toi le h√©ros !"
                },
                {
                    title: "Comment jouer ?",
                    text: "Lis, choisis, avance. Un bouton = une action. Clique sur ‚ñ∂ pour lancer le chapitre."
                },
                {
                    title: "Ton premier objectif",
                    text: "Parle au conseiller √† la mairie. Tes choix feront √©voluer l‚ÄôEmpathie, l‚ÄôAutonomie et l‚ÄôInclusion."
                }
            ];
            const isLast = step === steps.length - 1;
            return (
                <div className="fixed inset-0 bg-black/50 layer-50 flex items-center justify-center p-4">
                    <div
                        className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6"
                        role="dialog"
                        aria-modal="true"
                        aria-labelledby="onboard-title"
                        aria-describedby="onboard-desc"
                        tabIndex="-1"
                        ref={dialogRef}
                    >
                        <h3 id="onboard-title" className="text-2xl font-bold text-primary mb-2">{steps[step].title}</h3>
                        <p id="onboard-desc" className="text-gray-700 mb-6">{steps[step].text}</p>
                        <div className="flex justify-between items-center">
                            <button onClick={onClose} className="px-4 py-2 text-sm rounded border border-gray-300 hover:bg-gray-100">Passer</button>
                            <div className="flex gap-2 items-center">
                                {step > 0 && (
                                    <button onClick={() => setStep(step-1)} className="px-4 py-2 text-sm rounded bg-gray-100 hover:bg-gray-200">Pr√©c√©dent</button>
                                )}
                                <button
                                    onClick={() => { if (isLast) onClose(); else setStep(step+1); }}
                                    className="px-4 py-2 text-sm rounded bg-primary text-white hover:bg-primary-hover"
                                >
                                    {isLast ? 'Commencer' : 'Continuer'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // ==================== EDITOR MODE ====================
        
        function EditorMode({ scenes, characters, variables, onPlayScene, onEditCharacter, onAddCharacter, currentLayout, layout }) {
            // Extraire panneaux depuis la d√©finition de layout
            const findPanel = (id) => layout && layout.panels ? layout.panels.find(p => p.id === id) : null;
            const left = findPanel('scene-list') || { visible: true, width: 260 };
            const center = findPanel('inspector') || { visible: true };
            const right = findPanel('devtools') || { visible: false, width: 0 };

            return (
                <div>
                    <div className="mb-4 p-4 bg-blue-50 border-l-4 border-primary rounded">
                        <p className="text-sm text-gray-700">
                            <span className="font-semibold">üí° {currentLayout.charAt(0).toUpperCase()+currentLayout.slice(1)}</span> : {layout ? layout.description : 'Disposition editeur'}
                        </p>
                    </div>
                    <div className="flex gap-6 fade-in">
                    {/* Scene List - Hidden in focus mode */}
                    {left.visible && (
                    <div className="bg-white rounded-xl shadow-md p-6 card-hover" style={{ width: (left.width || 260) + 'px' }}>
                        <h2 className="text-xl font-bold mb-4 text-primary">üìã Chapitres</h2>
                        <div className="space-y-2">
                            {scenes.map(scene => (
                                <div key={scene.id} className="border-2 border-gray-200 rounded-lg p-3 hover:border-primary transition-all">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <h3 className="font-semibold">{scene.title}</h3>
                                            <p className="text-xs text-gray-500">{scene.dialogues.length} dialogues</p>
                                        </div>
                                        <button 
                                            onClick={() => onPlayScene(scene.id)}
                                            className="bg-primary text-white px-3 py-1 rounded-lg hover:bg-primary-hover transition-all text-sm"
                                        >
                                            ‚ñ∂
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    )}
                    
                    {/* Variables Inspector */}
                    {center.visible && (
                    <div className="bg-white rounded-xl shadow-md p-6 card-hover flex-1">
                        <h2 className="text-xl font-bold mb-4 text-primary">üìä Sentiments du heros</h2>
                        <div className="space-y-4">
                            {Object.entries(variables).map(([key, value]) => (
                                <div key={key}>
                                    <div className="flex justify-between mb-1">
                                        <span className="text-sm font-medium">{key}</span>
                                        <span className="text-sm font-bold text-primary">{value}%</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                        <div 
                                            className="h-full bg-gradient-to-r from-primary to-primary-hover transition-all duration-500"
                                            style={{ width: `${value}%` }}
                                        />
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    )}
                    
                    {/* Characters - Hidden in accessibility mode */}
                    {right.visible && (
                    <div className="bg-white rounded-xl shadow-md p-6 card-hover" style={{ width: (right.width || 280) + 'px' }}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-primary">üë• Mes personnages</h2>
                            <button 
                                onClick={onAddCharacter}
                                className="bg-primary text-white px-3 py-2 rounded-lg hover:bg-primary-hover transition-all text-sm"
                            >
                                + Nouveau
                            </button>
                        </div>
                        <div className="space-y-3">
                            {characters.map(char => (
                                <div key={char.id} className="border-2 border-gray-200 rounded-lg p-3 hover:border-primary transition-all cursor-pointer" onClick={() => onEditCharacter(char)}>
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h3 className="font-semibold">{char.name}</h3>
                                            <p className="text-xs text-gray-500">{char.moods.length} humeurs disponibles</p>
                                        </div>
                                        <span className="text-2xl">‚úèÔ∏è</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    )}
                    </div>
                </div>
            );
        }
        
        // ==================== CHARACTER EDITOR ====================
        
        function CharacterEditor({ character, onSave, onClose }) {
            const [editedChar, setEditedChar] = useState({ ...character });
            const [selectedMood, setSelectedMood] = useState('neutral');
            const [previewUrl, setPreviewUrl] = useState('');
            const dialogRef = useRef(null);
            useEffect(() => {
                const prevOverflow = document.body.style.overflow;
                document.body.style.overflow = 'hidden';
                const prevActive = document.activeElement;
                if (dialogRef.current) {
                    dialogRef.current.focus();
                }
                const cleanupTrap = trapFocus(dialogRef.current);
                return () => {
                    document.body.style.overflow = prevOverflow;
                    cleanupTrap && cleanupTrap();
                    if (prevActive && typeof prevActive.focus === 'function') {
                        try { prevActive.focus(); } catch {}
                    }
                };
            }, []);
            
            const handleFileUpload = (mood, event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    setEditedChar({
                        ...editedChar,
                        sprites: { ...editedChar.sprites, [mood]: e.target.result }
                    });
                    if (mood === selectedMood) {
                        setPreviewUrl(e.target.result);
                    }
                };
                reader.readAsDataURL(file);
            };
            
            const handleAddMood = () => {
                const newMood = prompt('Nom de la nouvelle humeur (ex: angry, surprised):');
                if (newMood && !editedChar.moods.includes(newMood)) {
                    setEditedChar({
                        ...editedChar,
                        moods: [...editedChar.moods, newMood],
                        sprites: { ...editedChar.sprites, [newMood]: '' }
                    });
                }
            };
            
            const handleRemoveMood = (mood) => {
                if (editedChar.moods.length <= 1) {
                    alert('‚ö†Ô∏è Au moins une humeur est requise.');
                    return;
                }
                const updatedMoods = editedChar.moods.filter(m => m !== mood);
                const updatedSprites = {...editedChar.sprites};
                delete updatedSprites[mood];
                setEditedChar({
                    ...editedChar,
                    moods: updatedMoods,
                    sprites: updatedSprites
                });
                if (selectedMood === mood) {
                    setSelectedMood(updatedMoods[0]);
                    setPreviewUrl(updatedSprites[updatedMoods[0]] || '');
                }
            };
            
            const handleSave = () => {
                onSave(editedChar);
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center layer-50 fade-in">
                    <div
                        className="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto"
                        role="dialog"
                        aria-modal="true"
                        aria-labelledby="character-editor-title"
                        tabIndex="-1"
                        ref={dialogRef}
                    >
                        <div className="gradient-bg text-white p-6 rounded-t-xl flex justify-between items-center">
                            <h2 id="character-editor-title" className="text-2xl font-bold">‚úèÔ∏è Editer {editedChar.name}</h2>
                            <button onClick={onClose} className="text-white text-3xl hover:opacity-75">&times;</button>
                        </div>
                        
                        <div className="p-6 space-y-6">
                            {/* Basic Info */}
                            <div>
                                <label className="block text-sm font-semibold mb-2">Nom du personnage</label>
                                <input 
                                    type="text"
                                    value={editedChar.name}
                                    onChange={(e) => setEditedChar({ ...editedChar, name: e.target.value })}
                                    className="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-primary outline-none"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-semibold mb-2">Description</label>
                                <textarea 
                                    value={editedChar.description}
                                    onChange={(e) => setEditedChar({ ...editedChar, description: e.target.value })}
                                    className="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-primary outline-none h-20"
                                />
                            </div>
                            
                            {/* Mood Selector */}
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm font-semibold">Humeurs disponibles</label>
                                    <button 
                                        onClick={handleAddMood}
                                        className="bg-primary text-white px-3 py-1 rounded-lg hover:bg-primary-hover text-sm"
                                    >
                                        + Ajouter humeur
                                    </button>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    {editedChar.moods.map(mood => (
                                        <div key={mood} className="relative">
                                            <button 
                                                onClick={() => {
                                                    setSelectedMood(mood);
                                                    setPreviewUrl(editedChar.sprites[mood] || '');
                                                }}
                                                className={'px-4 py-2 rounded-lg transition-all ' + (selectedMood === mood ? 'bg-primary text-white' : 'bg-gray-200 hover:bg-gray-300')}
                                            >
                                                {mood}
                                            </button>
                                            {editedChar.moods.length > 1 && (
                                                <button
                                                    onClick={() => handleRemoveMood(mood)}
                                                    className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs hover:bg-red-600"
                                                >√ó</button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Sprite Upload */}
                            <div className="border-2 border-dashed border-primary rounded-lg p-6">
                                <label className="block text-sm font-semibold mb-2">Image pour l'humeur: {selectedMood}</label>
                                <input 
                                    type="file"
                                    accept="image/*"
                                    onChange={(e) => handleFileUpload(selectedMood, e)}
                                    className="w-full mb-4"
                                />
                                {previewUrl && (
                                    <div className="text-center">
                                        <p className="text-xs text-gray-500 mb-2">Aper√ßu:</p>
                                        <img src={previewUrl} alt="Preview" className="max-w-full max-h-64 mx-auto rounded-lg shadow-md" />
                                    </div>
                                )}
                                {!previewUrl && (
                                    <p className="text-sm text-gray-400 text-center">Aucune image charg√©e pour {selectedMood}</p>
                                )}
                            </div>
                            
                            {/* Galerie de toutes les humeurs */}
                            <div>
                                <label className="block text-sm font-semibold mb-3">Aper√ßu de toutes les humeurs</label>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {editedChar.moods.map(mood => (
                                        <div key={mood} className="text-center border-2 border-gray-200 rounded-lg p-3 hover:border-primary transition-all">
                                            <p className="text-xs font-medium mb-2 capitalize">{mood}</p>
                                            {editedChar.sprites[mood] ? (
                                                <img src={editedChar.sprites[mood]} alt={mood} className="w-full h-20 object-cover rounded" />
                                            ) : (
                                                <div className="w-full h-20 bg-gray-100 rounded flex items-center justify-center text-gray-400 text-xs">
                                                    Pas d'image
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Actions */}
                            <div className="flex gap-4 justify-end pt-4 border-t-2">
                                <button 
                                    onClick={onClose}
                                    className="px-6 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-all"
                                >
                                    Annuler
                                </button>
                                <button 
                                    onClick={handleSave}
                                    className="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-all"
                                >
                                    Enregistrer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // ==================== PLAYER MODE ====================
        
        function PlayerMode({ scene, characters, variables, dialogueEngine, eventBus, onExit }) {
            const [currentDialogue, setCurrentDialogue] = useState(null);
            const [displayedVariables, setDisplayedVariables] = useState(variables);
            const [deltas, setDeltas] = useState([]);
            const [showHud, setShowHud] = useState(true); // Visible par d√©faut
            const [showCoach, setShowCoach] = useState(true);
            
            useEffect(() => {
                const handleDialogue = (data) => {
                    setCurrentDialogue(data);
                };
                
                const handleVariablesUpdate = (vars) => {
                    setDisplayedVariables(vars);
                };
                
                const handleSceneComplete = () => {
                    setTimeout(() => {
                        alert('Sc√®ne termin√©e !');
                        onExit();
                    }, 500);
                };
                
                eventBus.on('dialogue:show', handleDialogue);
                eventBus.on('variables:updated', handleVariablesUpdate);
                const handleVariablesDelta = (deltaList) => {
                    if (!Array.isArray(deltaList)) return;
                    deltaList.forEach(({ variable, delta }) => {
                        const id = `${Date.now()}-${Math.random()}`;
                        setDeltas((prev) => [...prev, { id, variable, delta }]);
                        setTimeout(() => {
                            setDeltas((prev) => prev.filter((d) => d.id !== id));
                        }, 1500);
                    });
                };
                eventBus.on('variables:delta', handleVariablesDelta);
                eventBus.on('scene:complete', handleSceneComplete);
                
                dialogueEngine.loadScene(scene);
                
                return () => {
                    eventBus.off('dialogue:show', handleDialogue);
                    eventBus.off('variables:updated', handleVariablesUpdate);
                    eventBus.off('variables:delta', handleVariablesDelta);
                    eventBus.off('scene:complete', handleSceneComplete);
                };
            }, [scene, dialogueEngine, eventBus, onExit]);
            
            const handleChoice = (choice) => {
                dialogueEngine.handleChoice(choice);
            };
            
            const handleNext = () => {
                dialogueEngine.next();
            };
            
            const getSpeakerName = (speakerId) => {
                if (speakerId === 'narrator') return 'Narrateur';
                const char = characters.find(c => c.id === speakerId);
                return char ? char.name : speakerId;
            };
            
            return (
                <div className="fade-in relative">
                    {/* Exit Button */}
                    <button 
                        onClick={onExit}
                        className="absolute top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all layer-50 shadow-lg"
                    >
                        ‚èπ Quitter
                    </button>
                    
                    {/* Variables HUD */
                    }
                    {/* HUD Variables optionnel */}
                    <div className="absolute top-4 left-4 layer-40">
                        <div className="mb-2 bg-white rounded-lg shadow p-2 inline-flex items-center gap-2">
                            <label className="text-xs text-gray-700">Afficher le HUD</label>
                            <input type="checkbox" checked={showHud} onChange={(e)=>setShowHud(e.target.checked)} />
                        </div>
                        {showHud && (
                            <div className="bg-white rounded-lg shadow-lg p-3 w-64">
                                <h3 className="font-bold text-sm mb-3 text-primary flex items-center gap-2">
                                    <span>üéØ</span>
                                    <span>√âtat du joueur</span>
                                </h3>
                                <div className="space-y-3">
                                    {Object.entries(displayedVariables).map(([key, value]) => {
                                        const icon = key === 'Physique' ? 'üí™' : key === 'Mentale' ? 'üß†' : 'üìä';
                                        const color = value > 66 ? 'from-green-500 to-green-600' : 
                                                     value > 33 ? 'from-yellow-500 to-yellow-600' : 
                                                     'from-red-500 to-red-600';
                                        return (
                                            <div key={key} className="flex items-center gap-2">
                                                <span className="text-lg">{icon}</span>
                                                <div className="flex-1">
                                                    <div className="flex justify-between mb-1">
                                                        <span className="text-xs font-semibold text-gray-700">{key}</span>
                                                        <span className="text-xs font-bold text-gray-900">{value}/100</span>
                                                    </div>
                                                    <div className="bg-gray-200 rounded-full h-3 shadow-inner">
                                                        <div 
                                                            className={`h-full bg-gradient-to-r ${color} rounded-full transition-all duration-500 shadow-sm`}
                                                            style={{ width: `${value}%` }}
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}
                    </div>
                    {/* Delta Badges */}
                    <div className="pointer-events-none absolute layer-50" style={{ top: '64px', left: '280px' }}>
                        {deltas.map((d) => (
                            <div
                                key={d.id}
                                className={`delta-badge mt-1 inline-block px-3 py-1 rounded-full text-sm font-semibold ${d.delta > 0 ? 'bg-emerald-600/90 text-white border border-emerald-400/60' : d.delta < 0 ? 'bg-rose-600/90 text-white border border-rose-400/60' : 'bg-slate-600/90 text-white border border-slate-400/60'}`}
                            >
                                {d.variable} {d.delta > 0 ? '+' : ''}{d.delta}
                            </div>
                        ))}
                    </div>
                    
                    {/* Stage */}
                    <div className="relative w-full bg-black rounded-xl overflow-hidden" style={{ minHeight: '600px' }}>
                        {/* Background */}
                        {scene?.backgroundUrl ? (
                            <img src={scene.backgroundUrl} alt="D√©cor" className="stage-background" />
                        ) : (
                            <div className="absolute inset-0 bg-gradient-to-b from-gray-800 to-gray-900" />
                        )}
                        
                        {/* Dialogue Box */}
                        {currentDialogue && (
                            <div className="dialogue-box">
                                <div className="mb-3">
                                    <span className="font-semibold text-primary-hover text-lg">
                                        {getSpeakerName(currentDialogue.speaker)}
                                    </span>
                                </div>
                                <p className="text-base leading-relaxed mb-4">{currentDialogue.text}</p>
                                
                                {currentDialogue.choices && currentDialogue.choices.length > 0 ? (
                                    <div className="space-y-2">
                                        {currentDialogue.choices.map((choice, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => handleChoice(choice)}
                                                className="choice-btn w-full"
                                            >
                                                ‚Üí {choice.text}
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="flex justify-end">
                                        <button
                                            onClick={handleNext}
                                            className="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-hover transition-all"
                                        >
                                            Suivant ‚Üí
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    {/* Coach marks: bulle d‚Äôaide jaune + assombrissement */}
                    {showCoach && (
                        <div className="fixed inset-0 layer-50">
                            <div className="absolute inset-0 overlay-dim" onClick={()=>setShowCoach(false)}></div>
                            <div className="absolute bottom-40 left-1/2 -translate-x-1/2 coach-bubble rounded-xl p-4 shadow-lg w-[420px]">
                                <div className="font-bold mb-1">Conseil</div>
                                <div className="text-sm">Lis le texte puis choisis une r√©ponse. Clique sur ¬´ Suivant ¬ª s‚Äôil n‚Äôy a pas de choix. Tu peux masquer le HUD pour te concentrer.</div>
                                <div className="mt-3 flex justify-end">
                                    <button className="px-3 py-1 rounded bg-yellow-300 hover:bg-yellow-400 text-sm" onClick={()=>setShowCoach(false)}>Compris</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // ==================== RENDER ====================
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
