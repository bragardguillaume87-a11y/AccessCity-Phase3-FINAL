<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AccessCity - Player & Editor</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        primary: '#0e639c',
                        'primary-hover': '#1177bb',
                        'primary-active': '#094771',
                        secondary: '#764ba2'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        * { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #0e639c 0%, #094771 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .btn-primary { 
            background: linear-gradient(135deg, #0e639c 0%, #1177bb 100%); 
            transition: all 0.3s; 
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 20px rgba(14, 99, 156, 0.4); 
        }
        .tab-active { 
            border-bottom: 3px solid #0e639c; 
            color: #0e639c; 
            font-weight: 600; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        
        .stage-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
        }
        
        .character-portrait {
            position: absolute;
            bottom: 0;
            max-height: 60%;
            z-index: 10;
            transition: all 0.5s ease;
        }
        
        .dialogue-box {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 800px;
            background: linear-gradient(135deg, rgba(37, 37, 38, 0.98) 0%, rgba(30, 30, 30, 0.95) 100%);
            border: 2px solid #0e639c;
            border-radius: 12px;
            padding: 24px;
            color: #e0e0e0;
            z-index: 20;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 0 0 20px rgba(14, 99, 156, 0.25);
        }
        
        .choice-btn {
            background: #2d2d30;
            color: #e0e0e0;
            padding: 12px 20px;
            border-radius: 8px;
            border: 1px solid #3e3e42;
            transition: all 0.2s;
            cursor: pointer;
            text-align: left;
        }
        .choice-btn:hover {
            background: #0e639c;
            border-color: #1177bb;
            transform: translateX(4px);
        }
        /* Badges de deltas variables */
        @keyframes riseFade {
            0% { opacity: 0; transform: translateY(8px) scale(0.98); }
            15% { opacity: 1; transform: translateY(0) scale(1); }
            85% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-8px) scale(0.98); }
        }
        .delta-badge { 
            animation: riseFade 1.5s ease forwards; 
            box-shadow: 0 6px 14px rgba(0,0,0,0.25);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ==================== CORE MODULES (Vanilla JS int√©gr√©s) ====================
        
        class EventBus {
            constructor() {
                this.events = {};
            }
            on(event, callback) {
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(callback);
            }
            emit(event, data) {
                if (this.events[event]) {
                    this.events[event].forEach(cb => cb(data));
                }
            }
            off(event, callback) {
                if (!this.events[event]) return;
                this.events[event] = this.events[event].filter(cb => cb !== callback);
            }
        }
        
        class VariableManager {
            constructor() {
                this.variables = {
                    'Empathie': 50,
                    'Autonomie': 50,
                    'Inclusion': 50,
                    'Stress': 50
                };
            }
            get(name) {
                return this.variables[name] !== undefined ? this.variables[name] : 0;
            }
            set(name, value) {
                this.variables[name] = value;
            }
            modify(name, delta) {
                const current = this.get(name);
                this.set(name, Math.max(0, Math.min(100, current + delta)));
            }
            getAll() {
                return { ...this.variables };
            }
        }
        
        class ConditionEvaluator {
            constructor(variableManager) {
                this.variableManager = variableManager;
            }
            evaluate(conditions) {
                if (!conditions || conditions.length === 0) return true;
                return conditions.every(cond => {
                    const varValue = this.variableManager.get(cond.variable);
                    switch (cond.operator) {
                        case '>=': return varValue >= cond.value;
                        case '<=': return varValue <= cond.value;
                        case '>': return varValue > cond.value;
                        case '<': return varValue < cond.value;
                        case '==': return varValue == cond.value;
                        case '!=': return varValue != cond.value;
                        default: return false;
                    }
                });
            }
        }
        
        class DialogueEngine {
            constructor(eventBus, variableManager) {
                this.eventBus = eventBus;
                this.variableManager = variableManager;
                this.conditionEvaluator = new ConditionEvaluator(variableManager);
                this.currentScene = null;
                this.currentDialogueIndex = 0;
            }
            
            loadScene(scene) {
                this.currentScene = scene;
                this.currentDialogueIndex = 0;
                this.showCurrentDialogue();
            }
            
            showCurrentDialogue() {
                if (!this.currentScene) return;
                
                while (this.currentDialogueIndex < this.currentScene.dialogues.length) {
                    const dialogue = this.currentScene.dialogues[this.currentDialogueIndex];
                    
                    if (this.conditionEvaluator.evaluate(dialogue.conditions)) {
                        this.eventBus.emit('dialogue:show', {
                            speaker: dialogue.speaker,
                            text: dialogue.text,
                            choices: dialogue.choices || []
                        });
                        return;
                    }
                    
                    this.currentDialogueIndex++;
                }
                
                this.eventBus.emit('scene:complete', { sceneId: this.currentScene.id });
            }
            
            handleChoice(choice) {
                if (choice.effects) {
                    const deltas = [];
                    choice.effects.forEach(effect => {
                        const before = this.variableManager.get(effect.variable);
                        if (effect.operation === 'set') {
                            this.variableManager.set(effect.variable, effect.value);
                            deltas.push({ variable: effect.variable, delta: effect.value - before });
                        } else if (effect.operation === 'add') {
                            this.variableManager.modify(effect.variable, effect.value);
                            deltas.push({ variable: effect.variable, delta: effect.value });
                        }
                    });
                    this.eventBus.emit('variables:delta', deltas);
                    this.eventBus.emit('variables:updated', this.variableManager.getAll());
                }
                this.next();
            }
            
            next() {
                this.currentDialogueIndex++;
                this.showCurrentDialogue();
            }
        }
        
        // ==================== DATA SAMPLE ====================
        
        const SAMPLE_DATA = {
            characters: [
                {
                    id: "player",
                    name: "Joueur",
                    sprites: { neutral: "assets/characters/player/neutral.svg" },
                    moods: ["neutral"]
                },
                {
                    id: "counsellor",
                    name: "Conseiller municipal",
                    sprites: { neutral: "assets/characters/counsellor/neutral.svg" },
                    moods: ["neutral", "professional", "helpful"]
                },
                {
                    id: "narrator",
                    name: "Narrateur",
                    sprites: {},
                    moods: []
                }
            ],
            scenes: [
                {
                    id: "scene_test_01",
                    title: "Rencontre Mairie",
                    description: "Premiere scene de test avec variables.",
                    dialogues: [
                        {
                            speaker: "narrator",
                            text: "Vous arrivez devant l'imposant batiment de la mairie."
                        },
                        {
                            speaker: "counsellor",
                            text: "Bonjour ! Je suis ravi de vous voir pour discuter du projet d'accessibilite."
                        },
                        {
                            speaker: "player",
                            text: "...",
                            choices: [
                                {
                                    text: "Bonjour, je suis tres motive !",
                                    effects: [{ variable: "Empathie", value: 60, operation: "set" }]
                                },
                                {
                                    text: "Je n'ai pas beaucoup de temps.",
                                    effects: [{ variable: "Empathie", value: 40, operation: "set" }]
                                }
                            ]
                        },
                        {
                            speaker: "counsellor",
                            text: "C'est formidable de sentir votre enthousiasme !",
                            conditions: [{ variable: "Empathie", operator: ">=", value: 60 }]
                        },
                        {
                            speaker: "counsellor",
                            text: "Tres bien, nous allons faire vite alors.",
                            conditions: [{ variable: "Empathie", operator: "<", value: 60 }]
                        },
                        {
                            speaker: "narrator",
                            text: "Apres l'entretien, vous retournez a votre vehicule."
                        }
                    ]
                },
                {
                    id: "scene_test_02",
                    title: "Suite de l'aventure",
                    description: "Deuxieme scene.",
                    dialogues: [
                        {
                            speaker: "narrator",
                            text: "Une nouvelle journee commence..."
                        }
                    ]
                }
            ]
        };
        
        // ==================== UI LAYOUTS (fallback minimal si fetch indisponible) ====================
        const FALLBACK_LAYOUTS = {
            version: "fallback",
            layouts: {
                standard: {
                    description: "Disposition editeur complete",
                    panels: [
                        { id: 'scene-list', visible: true, position: 'left', width: 260 },
                        { id: 'inspector', visible: true, position: 'center', flex: 1 },
                        { id: 'devtools', visible: true, position: 'right', width: 320 }
                    ]
                },
                focus: {
                    description: "Mode focus sur l'ecriture",
                    panels: [
                        { id: 'scene-list', visible: false, position: 'left', width: 0 },
                        { id: 'inspector', visible: true, position: 'center', flex: 1 },
                        { id: 'devtools', visible: true, position: 'right', width: 280 }
                    ]
                },
                accessibility: {
                    description: "Mode accessibilite",
                    panels: [
                        { id: 'scene-list', visible: true, position: 'left', width: 300 },
                        { id: 'inspector', visible: true, position: 'center', flex: 1 },
                        { id: 'devtools', visible: false, position: 'right', width: 0 }
                    ]
                },
                devtools: {
                    description: "Mode debug",
                    panels: [
                        { id: 'scene-list', visible: true, position: 'left', width: 220 },
                        { id: 'inspector', visible: true, position: 'center', flex: 1 },
                        { id: 'devtools', visible: true, position: 'right', width: 380 }
                    ]
                }
            }
        };
        
        // ==================== MAIN APP ====================
        
        function App() {
            const [mode, setMode] = useState('editor'); // 'editor' or 'player'
            // Accessibilit√© par d√©faut pour une meilleure lisibilit√©
            const [currentLayout, setCurrentLayout] = useState('accessibility');
            const [scenes, setScenes] = useState(SAMPLE_DATA.scenes);
            const [characters, setCharacters] = useState(SAMPLE_DATA.characters);
            const [selectedSceneId, setSelectedSceneId] = useState(null);
            const [variables, setVariables] = useState({ Empathie: 50, Autonomie: 50, Inclusion: 50, Stress: 50 });
            const [editingCharacter, setEditingCharacter] = useState(null);
            // UI layouts charg√©s depuis data/ui_layout.json
            const [uiLayouts, setUiLayouts] = useState(null);
            // Onboarding + objectif courant
            const [showOnboarding, setShowOnboarding] = useState(false);
            const [objective, setObjective] = useState("Parler au conseiller √† la mairie");
            const [showHint, setShowHint] = useState(false);
            
            const eventBusRef = useRef(new EventBus());
            const variableManagerRef = useRef(new VariableManager());
            const dialogueEngineRef = useRef(null);
            
            useEffect(() => {
                dialogueEngineRef.current = new DialogueEngine(
                    eventBusRef.current,
                    variableManagerRef.current
                );
                
                eventBusRef.current.on('variables:updated', (vars) => {
                    setVariables(vars);
                });
                // Auto-s√©lectionner le premier chapitre et afficher onboarding au premier d√©marrage
                if (SAMPLE_DATA.scenes && SAMPLE_DATA.scenes.length > 0) {
                    setSelectedSceneId(SAMPLE_DATA.scenes[0].id);
                }
                const onboarded = window.localStorage.getItem('ac_onboarded');
                if (!onboarded) {
                    setShowOnboarding(true);
                }
                // Charger layouts JSON avec fallback
                (async () => {
                    try {
                        const res = await fetch('data/ui_layout.json');
                        if (!res.ok) throw new Error('fetch failed');
                        const json = await res.json();
                        setUiLayouts(json);
                    } catch (e) {
                        setUiLayouts(FALLBACK_LAYOUTS);
                    }
                })();
            }, []);
            
            const playScene = (sceneId) => {
                const scene = scenes.find(s => s.id === sceneId);
                if (!scene) return;
                setSelectedSceneId(sceneId);
                setMode('player');
            };
            
            const saveCharacter = (updatedCharacter) => {
                setCharacters(chars => chars.map(c => c.id === updatedCharacter.id ? updatedCharacter : c));
                setEditingCharacter(null);
                eventBusRef.current.emit('character:updated', updatedCharacter);
            };
            
            const addNewCharacter = () => {
                const newChar = {
                    id: `custom_${Date.now()}`,
                    name: 'Nouveau personnage',
                    description: 'Un nouveau personnage',
                    sprites: { neutral: '', happy: '', sad: '', professional: '' },
                    moods: ['neutral']
                };
                setCharacters([...characters, newChar]);
                setEditingCharacter(newChar);
            };
            
            return (
                <div className="min-h-screen">
                    <header className="gradient-bg text-white py-6 shadow-lg">
                        <div className="container mx-auto px-4">
                            <h1 className="text-3xl font-bold">üéÆ AccessCity - Player & Editor</h1>
                            <p className="text-sm opacity-90 mt-1">Moteur narratif interactif avec variables</p>
                        </div>
                    </header>
                    
                    <div className="bg-white shadow-md border-b-2 border-gray-200">
                        <div className="container mx-auto px-4">
                            <div className="flex justify-between items-center">
                                <div className="flex gap-4">
                                    <button
                                        onClick={() => setMode('editor')}
                                        className={'px-6 py-4 transition-all ' + (mode === 'editor' ? 'tab-active' : 'text-gray-600 hover:bg-gray-50')}
                                    >
                                        ‚úèÔ∏è Cr√©er mon histoire
                                    </button>
                                    <button
                                        onClick={() => setMode('player')}
                                        className={'px-6 py-4 transition-all ' + (mode === 'player' ? 'tab-active' : 'text-gray-600 hover:bg-gray-50')}
                                        disabled={!selectedSceneId}
                                    >
                                        ‚ñ∂Ô∏è Jouer
                                    </button>
                                </div>
                                {mode === 'editor' && (
                                    <div className="flex gap-2 items-center">
                                        <span className="text-sm text-gray-600 mr-2">Vue :</span>
                                        <button
                                            onClick={() => setCurrentLayout('standard')}
                                            className={'px-3 py-2 text-sm rounded transition-all ' + (currentLayout === 'standard' ? 'bg-primary text-white' : 'bg-gray-100 hover:bg-gray-200')}
                                        >
                                            Standard
                                        </button>
                                        <button
                                            onClick={() => setCurrentLayout('focus')}
                                            className={'px-3 py-2 text-sm rounded transition-all ' + (currentLayout === 'focus' ? 'bg-primary text-white' : 'bg-gray-100 hover:bg-gray-200')}
                                        >
                                            Focus
                                        </button>
                                        <button
                                            onClick={() => setCurrentLayout('accessibility')}
                                            className={'px-3 py-2 text-sm rounded transition-all ' + (currentLayout === 'accessibility' ? 'bg-primary text-white' : 'bg-gray-100 hover:bg-gray-200')}
                                        >
                                            Accessibilit√©
                                        </button>
                                        <button
                                            onClick={() => setCurrentLayout('devtools')}
                                            className={'px-3 py-2 text-sm rounded transition-all ' + (currentLayout === 'devtools' ? 'bg-primary text-white' : 'bg-gray-100 hover:bg-gray-200')}
                                        >
                                            Debug
                                        </button>
                                    </div>
                                )}
                            </div>
                            {/* HUD Objectif + aide */}
                            <div className="flex items-center justify-between py-3 text-gray-700">
                                <div className="flex items-center gap-2">
                                    <span className="text-base font-semibold text-primary">üéØ Objectif:</span>
                                    <span className="text-base font-medium">{objective}</span>
                                </div>
                                <button
                                    onClick={() => setShowHint(v => !v)}
                                    className="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-sm"
                                >
                                    O√π aller ?
                                </button>
                            </div>
                            {showHint && (
                                <div className="mb-3 p-3 bg-blue-50 border-l-4 border-primary rounded text-sm text-gray-700">
                                    Astuce: ouvre l‚Äôonglet ‚Äúüìã Chapitres‚Äù et clique sur le bouton ‚ñ∂ du premier chapitre pour commencer. Bonne chance !
                                </div>
                            )}
                        </div>
                    </div>
                    
                    <div className="container mx-auto px-4 py-8">
                        {mode === 'editor' && (
                            <>
                                <EditorMode 
                                    scenes={scenes} 
                                    characters={characters}
                                    variables={variables}
                                    onPlayScene={playScene}
                                    onEditCharacter={setEditingCharacter}
                                    onAddCharacter={addNewCharacter}
                                    currentLayout={currentLayout}
                                    layout={uiLayouts ? uiLayouts.layouts[currentLayout] : null}
                                />
                                {editingCharacter && (
                                    <CharacterEditor 
                                        character={editingCharacter}
                                        onSave={saveCharacter}
                                        onClose={() => setEditingCharacter(null)}
                                    />
                                )}
                            </>
                        )}
                        {mode === 'player' && selectedSceneId && (
                            <PlayerMode 
                                scene={scenes.find(s => s.id === selectedSceneId)}
                                characters={characters}
                                variables={variables}
                                dialogueEngine={dialogueEngineRef.current}
                                eventBus={eventBusRef.current}
                                onExit={() => setMode('editor')}
                            />
                        )}
                        {showOnboarding && (
                            <OnboardingModal 
                                onClose={() => { window.localStorage.setItem('ac_onboarded','true'); setShowOnboarding(false); }}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // ==================== ONBOARDING MODAL ====================
        function OnboardingModal({ onClose }) {
            const [step, setStep] = useState(0);
            const steps = [
                {
                    title: "Bienvenue dans AccessCity !",
                    text: "Tu vas aider √† rendre la ville plus accueillante. C‚Äôest toi le h√©ros !"
                },
                {
                    title: "Comment jouer ?",
                    text: "Lis, choisis, avance. Un bouton = une action. Clique sur ‚ñ∂ pour lancer le chapitre."
                },
                {
                    title: "Ton premier objectif",
                    text: "Parle au conseiller √† la mairie. Tes choix feront √©voluer l‚ÄôEmpathie, l‚ÄôAutonomie et l‚ÄôInclusion."
                }
            ];
            const isLast = step === steps.length - 1;
            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6">
                        <h3 className="text-2xl font-bold text-primary mb-2">{steps[step].title}</h3>
                        <p className="text-gray-700 mb-6">{steps[step].text}</p>
                        <div className="flex justify-between items-center">
                            <button onClick={onClose} className="px-4 py-2 text-sm rounded border border-gray-300 hover:bg-gray-100">Passer</button>
                            <div className="flex gap-2 items-center">
                                {step > 0 && (
                                    <button onClick={() => setStep(step-1)} className="px-4 py-2 text-sm rounded bg-gray-100 hover:bg-gray-200">Pr√©c√©dent</button>
                                )}
                                <button
                                    onClick={() => { if (isLast) onClose(); else setStep(step+1); }}
                                    className="px-4 py-2 text-sm rounded bg-primary text-white hover:bg-primary-hover"
                                >
                                    {isLast ? 'Commencer' : 'Continuer'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // ==================== EDITOR MODE ====================
        
        function EditorMode({ scenes, characters, variables, onPlayScene, onEditCharacter, onAddCharacter, currentLayout, layout }) {
            // Extraire panneaux depuis la d√©finition de layout
            const findPanel = (id) => layout && layout.panels ? layout.panels.find(p => p.id === id) : null;
            const left = findPanel('scene-list') || { visible: true, width: 260 };
            const center = findPanel('inspector') || { visible: true };
            const right = findPanel('devtools') || { visible: false, width: 0 };

            return (
                <div>
                    <div className="mb-4 p-4 bg-blue-50 border-l-4 border-primary rounded">
                        <p className="text-sm text-gray-700">
                            <span className="font-semibold">üí° {currentLayout.charAt(0).toUpperCase()+currentLayout.slice(1)}</span> : {layout ? layout.description : 'Disposition editeur'}
                        </p>
                    </div>
                    <div className="flex gap-6 fade-in">
                    {/* Scene List - Hidden in focus mode */}
                    {left.visible && (
                    <div className="bg-white rounded-xl shadow-md p-6 card-hover" style={{ width: (left.width || 260) + 'px' }}>
                        <h2 className="text-xl font-bold mb-4 text-primary">üìã Chapitres</h2>
                        <div className="space-y-2">
                            {scenes.map(scene => (
                                <div key={scene.id} className="border-2 border-gray-200 rounded-lg p-3 hover:border-primary transition-all">
                                    <div className="flex justify-between items-start">
                                        <div className="flex-1">
                                            <h3 className="font-semibold">{scene.title}</h3>
                                            <p className="text-xs text-gray-500">{scene.dialogues.length} dialogues</p>
                                        </div>
                                        <button 
                                            onClick={() => onPlayScene(scene.id)}
                                            className="bg-primary text-white px-3 py-1 rounded-lg hover:bg-primary-hover transition-all text-sm"
                                        >
                                            ‚ñ∂
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    )}
                    
                    {/* Variables Inspector */}
                    {center.visible && (
                    <div className="bg-white rounded-xl shadow-md p-6 card-hover flex-1">
                        <h2 className="text-xl font-bold mb-4 text-primary">üìä Sentiments du heros</h2>
                        <div className="space-y-4">
                            {Object.entries(variables).map(([key, value]) => (
                                <div key={key}>
                                    <div className="flex justify-between mb-1">
                                        <span className="text-sm font-medium">{key}</span>
                                        <span className="text-sm font-bold text-primary">{value}%</span>
                                    </div>
                                    <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                        <div 
                                            className="h-full bg-gradient-to-r from-primary to-primary-hover transition-all duration-500"
                                            style={{ width: `${value}%` }}
                                        />
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    )}
                    
                    {/* Characters - Hidden in accessibility mode */}
                    {right.visible && (
                    <div className="bg-white rounded-xl shadow-md p-6 card-hover" style={{ width: (right.width || 280) + 'px' }}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-primary">üë• Mes personnages</h2>
                            <button 
                                onClick={onAddCharacter}
                                className="bg-primary text-white px-3 py-2 rounded-lg hover:bg-primary-hover transition-all text-sm"
                            >
                                + Nouveau
                            </button>
                        </div>
                        <div className="space-y-3">
                            {characters.map(char => (
                                <div key={char.id} className="border-2 border-gray-200 rounded-lg p-3 hover:border-primary transition-all cursor-pointer" onClick={() => onEditCharacter(char)}>
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <h3 className="font-semibold">{char.name}</h3>
                                            <p className="text-xs text-gray-500">{char.moods.length} humeurs disponibles</p>
                                        </div>
                                        <span className="text-2xl">‚úèÔ∏è</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    )}
                    </div>
                </div>
            );
        }
        
        // ==================== CHARACTER EDITOR ====================
        
        function CharacterEditor({ character, onSave, onClose }) {
            const [editedChar, setEditedChar] = useState({ ...character });
            const [selectedMood, setSelectedMood] = useState('neutral');
            const [previewUrl, setPreviewUrl] = useState('');
            
            const handleFileUpload = (mood, event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    setEditedChar({
                        ...editedChar,
                        sprites: { ...editedChar.sprites, [mood]: e.target.result }
                    });
                    if (mood === selectedMood) {
                        setPreviewUrl(e.target.result);
                    }
                };
                reader.readAsDataURL(file);
            };
            
            const handleAddMood = () => {
                const newMood = prompt('Nom de la nouvelle humeur (ex: angry, surprised):');
                if (newMood && !editedChar.moods.includes(newMood)) {
                    setEditedChar({
                        ...editedChar,
                        moods: [...editedChar.moods, newMood],
                        sprites: { ...editedChar.sprites, [newMood]: '' }
                    });
                }
            };
            
            const handleSave = () => {
                onSave(editedChar);
            };
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 fade-in">
                    <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div className="gradient-bg text-white p-6 rounded-t-xl flex justify-between items-center">
                            <h2 className="text-2xl font-bold">‚úèÔ∏è Editer {editedChar.name}</h2>
                            <button onClick={onClose} className="text-white text-3xl hover:opacity-75">&times;</button>
                        </div>
                        
                        <div className="p-6 space-y-6">
                            {/* Basic Info */}
                            <div>
                                <label className="block text-sm font-semibold mb-2">Nom du personnage</label>
                                <input 
                                    type="text"
                                    value={editedChar.name}
                                    onChange={(e) => setEditedChar({ ...editedChar, name: e.target.value })}
                                    className="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-primary outline-none"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-sm font-semibold mb-2">Description</label>
                                <textarea 
                                    value={editedChar.description}
                                    onChange={(e) => setEditedChar({ ...editedChar, description: e.target.value })}
                                    className="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-primary outline-none h-20"
                                />
                            </div>
                            
                            {/* Mood Selector */}
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm font-semibold">Humeurs disponibles</label>
                                    <button 
                                        onClick={handleAddMood}
                                        className="bg-primary text-white px-3 py-1 rounded-lg hover:bg-primary-hover text-sm"
                                    >
                                        + Ajouter humeur
                                    </button>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    {editedChar.moods.map(mood => (
                                        <button 
                                            key={mood}
                                            onClick={() => {
                                                setSelectedMood(mood);
                                                setPreviewUrl(editedChar.sprites[mood] || '');
                                            }}
                                            className={'px-4 py-2 rounded-lg transition-all ' + (selectedMood === mood ? 'bg-primary text-white' : 'bg-gray-200 hover:bg-gray-300')}
                                        >
                                            {mood}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            
                            {/* Sprite Upload */}
                            <div className="border-2 border-dashed border-primary rounded-lg p-6">
                                <label className="block text-sm font-semibold mb-2">Image pour l'humeur: {selectedMood}</label>
                                <input 
                                    type="file"
                                    accept="image/*"
                                    onChange={(e) => handleFileUpload(selectedMood, e)}
                                    className="w-full mb-4"
                                />
                                {previewUrl && (
                                    <div className="text-center">
                                        <p className="text-xs text-gray-500 mb-2">Apercu:</p>
                                        <img src={previewUrl} alt="Preview" className="max-w-full max-h-64 mx-auto rounded-lg shadow-md" />
                                    </div>
                                )}
                            </div>
                            
                            {/* Actions */}
                            <div className="flex gap-4 justify-end pt-4 border-t-2">
                                <button 
                                    onClick={onClose}
                                    className="px-6 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-100 transition-all"
                                >
                                    Annuler
                                </button>
                                <button 
                                    onClick={handleSave}
                                    className="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-hover transition-all"
                                >
                                    Enregistrer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        // ==================== PLAYER MODE ====================
        
        function PlayerMode({ scene, characters, variables, dialogueEngine, eventBus, onExit }) {
            const [currentDialogue, setCurrentDialogue] = useState(null);
            const [displayedVariables, setDisplayedVariables] = useState(variables);
            const [deltas, setDeltas] = useState([]);
            
            useEffect(() => {
                const handleDialogue = (data) => {
                    setCurrentDialogue(data);
                };
                
                const handleVariablesUpdate = (vars) => {
                    setDisplayedVariables(vars);
                };
                
                const handleSceneComplete = () => {
                    setTimeout(() => {
                        alert('Sc√®ne termin√©e !');
                        onExit();
                    }, 500);
                };
                
                eventBus.on('dialogue:show', handleDialogue);
                eventBus.on('variables:updated', handleVariablesUpdate);
                const handleVariablesDelta = (deltaList) => {
                    if (!Array.isArray(deltaList)) return;
                    deltaList.forEach(({ variable, delta }) => {
                        const id = `${Date.now()}-${Math.random()}`;
                        setDeltas((prev) => [...prev, { id, variable, delta }]);
                        setTimeout(() => {
                            setDeltas((prev) => prev.filter((d) => d.id !== id));
                        }, 1500);
                    });
                };
                eventBus.on('variables:delta', handleVariablesDelta);
                eventBus.on('scene:complete', handleSceneComplete);
                
                dialogueEngine.loadScene(scene);
                
                return () => {
                    eventBus.off('dialogue:show', handleDialogue);
                    eventBus.off('variables:updated', handleVariablesUpdate);
                    eventBus.off('variables:delta', handleVariablesDelta);
                    eventBus.off('scene:complete', handleSceneComplete);
                };
            }, [scene, dialogueEngine, eventBus, onExit]);
            
            const handleChoice = (choice) => {
                dialogueEngine.handleChoice(choice);
            };
            
            const handleNext = () => {
                dialogueEngine.next();
            };
            
            const getSpeakerName = (speakerId) => {
                if (speakerId === 'narrator') return 'Narrateur';
                const char = characters.find(c => c.id === speakerId);
                return char ? char.name : speakerId;
            };
            
            return (
                <div className="fade-in">
                    {/* Exit Button */}
                    <button 
                        onClick={onExit}
                        className="fixed top-20 right-4 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all z-50 shadow-lg"
                    >
                        ‚èπ Quitter
                    </button>
                    
                    {/* Variables HUD */
                    }
                    <div className="fixed top-20 left-4 bg-white rounded-lg shadow-lg p-4 z-50 w-64">
                        <h3 className="font-bold text-sm mb-2 text-primary">Variables</h3>
                        <div className="space-y-2">
                            {Object.entries(displayedVariables).map(([key, value]) => (
                                <div key={key} className="flex items-center gap-2">
                                    <span className="text-xs font-medium w-20">{key}</span>
                                    <div className="flex-1 bg-gray-200 rounded-full h-2">
                                        <div 
                                            className="h-full bg-gradient-to-r from-primary to-primary-hover rounded-full transition-all duration-500"
                                            style={{ width: `${value}%` }}
                                        />
                                    </div>
                                    <span className="text-xs font-bold w-8 text-right">{value}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                    {/* Delta Badges */}
                    <div className="pointer-events-none fixed z-40" style={{ top: '64px', left: '280px' }}>
                        {deltas.map((d) => (
                            <div
                                key={d.id}
                                className={`delta-badge mt-1 inline-block px-3 py-1 rounded-full text-sm font-semibold ${d.delta > 0 ? 'bg-emerald-600/90 text-white border border-emerald-400/60' : d.delta < 0 ? 'bg-rose-600/90 text-white border border-rose-400/60' : 'bg-slate-600/90 text-white border border-slate-400/60'}`}
                            >
                                {d.variable} {d.delta > 0 ? '+' : ''}{d.delta}
                            </div>
                        ))}
                    </div>
                    
                    {/* Stage */}
                    <div className="relative w-full bg-black rounded-xl overflow-hidden" style={{ minHeight: '600px' }}>
                        {/* Background */}
                        <div className="absolute inset-0 bg-gradient-to-b from-gray-800 to-gray-900" />
                        
                        {/* Dialogue Box */}
                        {currentDialogue && (
                            <div className="dialogue-box">
                                <div className="mb-3">
                                    <span className="font-semibold text-primary-hover text-lg">
                                        {getSpeakerName(currentDialogue.speaker)}
                                    </span>
                                </div>
                                <p className="text-base leading-relaxed mb-4">{currentDialogue.text}</p>
                                
                                {currentDialogue.choices && currentDialogue.choices.length > 0 ? (
                                    <div className="space-y-2">
                                        {currentDialogue.choices.map((choice, idx) => (
                                            <button
                                                key={idx}
                                                onClick={() => handleChoice(choice)}
                                                className="choice-btn w-full"
                                            >
                                                ‚Üí {choice.text}
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="flex justify-end">
                                        <button
                                            onClick={handleNext}
                                            className="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary-hover transition-all"
                                        >
                                            Suivant ‚Üí
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        // ==================== RENDER ====================
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
