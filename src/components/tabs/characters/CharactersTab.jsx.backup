import React, { useState } from 'react';
import { useTranslation } from 'react-i18next';

// Imports depuis les sous-dossiers que nous venons de remplir
import { CharactersExplorer } from './panels/CharactersExplorer';
import { CharacterEditor } from './panels/CharacterEditor';
import { CharacterProperties } from './panels/CharacterProperties';
import { useCharacters } from './hooks/useCharacters';

// Import du CSS Module principal (créé à l'étape 2)
import styles from './CharactersTab.module.css';

export const CharactersTab = ({ scenes = [] }) => {
  const { t } = useTranslation('characters');
  const {
    characters,
    createCharacter,
    duplicateCharacter,
    removeCharacter,
    updateCharacter
  } = useCharacters();

  const [selectedId, setSelectedId] = useState(null);
  const [editingCharacter, setEditingCharacter] = useState(null);

  const selectedCharacter = characters.find(c => c.id === selectedId);

  const handleCreate = () => {
    const newId = createCharacter();
    setSelectedId(newId);
    // On ouvre l'éditeur directement après création
    const newChar = characters.find(c => c.id === newId);
    // Petit délai pour laisser le temps au state de se mettre à jour si besoin
    setTimeout(() => {
        // On récupère le perso frais depuis le hook si possible, sinon on attend
        if (newChar) setEditingCharacter(newChar);
    }, 0);
  };

  const handleDuplicate = (charId) => {
    const duplicateId = duplicateCharacter(charId);
    if (duplicateId) {
      setSelectedId(duplicateId);
    }
  };

  const handleDelete = (charId) => {
    const result = removeCharacter(charId);
    if (!result.success) {
      alert(result.error);
      return;
    }
    if (selectedId === charId) {
      setSelectedId(null);
    }
  };

  const handleEdit = (character) => {
    setEditingCharacter(character);
  };

  const handleSave = (updatedCharacter) => {
    updateCharacter(updatedCharacter);
    setEditingCharacter(null);
  };

  const labels = {
    characters: t('characters', 'Personnages'),
    new: t('new', 'Nouveau'),
    noCharacters: t('noCharacters', 'Aucun personnage'),
    editCharacter: t('editCharacter', 'Éditer le personnage'),
    save: t('save', 'Enregistrer'),
    cancel: t('cancel', 'Annuler'),
    name: t('name', 'Nom'),
    description: t('description', 'Description'),
    properties: t('properties', 'Propriétés'),
    selectCharacter: t('selectCharacter', 'Sélectionnez un personnage'),
    // ... autres labels si besoin
  };

  return (
    <div className={styles.container}>
      {/* 1. Panneau Gauche : Liste */}
      <CharactersExplorer
        characters={characters}
        selectedId={selectedId}
        onSelect={setSelectedId}
        onCreate={handleCreate}
        onDuplicate={handleDuplicate}
        onDelete={handleDelete}
        labels={labels}
      />

      {/* 2. Panneau Central : Prévisualisation */}
      <main className={styles.main}>
        {selectedCharacter ? (
          <div className={styles.details}>
            <header className={styles.detailsHeader}>
              <h2>{selectedCharacter.name}</h2>
              <button
                onClick={() => handleEdit(selectedCharacter)}
                className={styles.editBtn}
              >
                {t('edit', 'Éditer')}
              </button>
            </header>

            <div className={styles.avatarPreview}>
              {selectedCharacter.sprites && Object.entries(selectedCharacter.sprites).map(([mood, url]) => (
                <div key={mood} className={styles.avatarItem}>
                  {/* Placeholder si pas d'image */}
                  {url ? <img src={url} alt={mood} /> : <div style={{width: 100, height: 120, background: '#eee', display: 'flex', alignItems: 'center', justifyContent: 'center'}}>?</div>}
                  <span>{mood}</span>
                </div>
              ))}
            </div>

            <p className={styles.description}>
              {selectedCharacter.description || <em>Aucune description</em>}
            </p>
          </div>
        ) : (
          <div className={styles.placeholder}>
            <p>Sélectionnez un personnage pour voir les détails</p>
          </div>
        )}
      </main>

      {/* 3. Panneau Droit : Propriétés techniques */}
      <CharacterProperties
        character={selectedCharacter}
        scenes={scenes}
        labels={labels}
      />

      {/* 4. Modale d'édition */}
      {editingCharacter && (
        <CharacterEditor
          character={editingCharacter}
          characters={characters}
          onSave={handleSave}
          onClose={() => setEditingCharacter(null)}
          labels={labels}
        />
      )}
    </div>
  );
};
